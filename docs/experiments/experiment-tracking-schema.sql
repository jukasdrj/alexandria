-- Experiment Tracking Schema for Gemini Prompt A/B Testing
-- Created: 2026-01-07
-- Purpose: Track prompt variants, results, and metrics for backfill optimization

-- =============================================================================
-- experiment_runs - Tracks each experiment run
-- =============================================================================
CREATE TABLE IF NOT EXISTS experiment_runs (
  id TEXT PRIMARY KEY,  -- UUID generated by application
  experiment_name TEXT NOT NULL,  -- e.g., "diversity-emphasis-v1", "baseline"
  prompt_text TEXT NOT NULL,  -- Full prompt for reproducibility
  system_instruction TEXT,  -- System instruction if different from default
  model TEXT NOT NULL,  -- e.g., "gemini-2.5-flash", "gemini-2.5-pro"
  year INTEGER NOT NULL,  -- Year tested
  month INTEGER,  -- Month tested (NULL for annual)
  dry_run BOOLEAN DEFAULT true,  -- Whether this was a dry-run (no ISBNdb enrichment)
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by TEXT DEFAULT 'system',  -- Who ran this experiment
  notes TEXT  -- Optional notes about test conditions
);

CREATE INDEX IF NOT EXISTS idx_experiment_runs_name ON experiment_runs(experiment_name);
CREATE INDEX IF NOT EXISTS idx_experiment_runs_year_month ON experiment_runs(year, month);
CREATE INDEX IF NOT EXISTS idx_experiment_runs_created_at ON experiment_runs(created_at DESC);

-- =============================================================================
-- experiment_results - Aggregated metrics for each experiment run
-- =============================================================================
CREATE TABLE IF NOT EXISTS experiment_results (
  id SERIAL PRIMARY KEY,
  run_id TEXT NOT NULL REFERENCES experiment_runs(id) ON DELETE CASCADE,

  -- Generation metrics
  isbns_generated INTEGER NOT NULL,  -- Total ISBNs from Gemini
  valid_isbns INTEGER NOT NULL,  -- ISBNs that passed checksum validation
  invalid_isbns INTEGER NOT NULL,  -- ISBNs that failed checksum
  high_confidence_count INTEGER DEFAULT 0,  -- Count of high-confidence ISBNs
  low_confidence_count INTEGER DEFAULT 0,  -- Count of low-confidence ISBNs
  unknown_confidence_count INTEGER DEFAULT 0,  -- Count of unknown-confidence ISBNs

  -- Deduplication breakdown
  dedup_exact INTEGER NOT NULL,  -- Already in enriched_editions (exact ISBN match)
  dedup_related INTEGER NOT NULL,  -- In related_isbns field
  dedup_fuzzy INTEGER NOT NULL,  -- Fuzzy title match
  new_isbns INTEGER NOT NULL,  -- ISBNs not found in database

  -- Enrichment results (0 if dry_run=true)
  enriched_count INTEGER DEFAULT 0,  -- Successfully enriched editions
  covers_queued INTEGER DEFAULT 0,  -- Covers queued for download

  -- API usage
  gemini_calls INTEGER DEFAULT 1,  -- Gemini API calls
  isbndb_calls INTEGER DEFAULT 0,  -- ISBNdb API calls
  total_api_calls INTEGER DEFAULT 1,  -- Sum of above

  -- Cost estimates (in USD)
  gemini_cost_estimate NUMERIC(10, 4) DEFAULT 0,  -- Estimated Gemini cost
  isbndb_cost_estimate NUMERIC(10, 4) DEFAULT 0,  -- Estimated ISBNdb cost
  total_cost_estimate NUMERIC(10, 4) DEFAULT 0,  -- Total estimated cost

  -- Performance
  duration_ms INTEGER NOT NULL,  -- Total execution time

  -- Calculated metrics
  hit_rate NUMERIC(5, 2) GENERATED ALWAYS AS (
    CASE
      WHEN isbns_generated > 0
      THEN (new_isbns::numeric / isbns_generated::numeric * 100)
      ELSE 0
    END
  ) STORED,  -- Hit rate: new_isbns / total * 100

  exact_dedup_rate NUMERIC(5, 2) GENERATED ALWAYS AS (
    CASE
      WHEN isbns_generated > 0
      THEN (dedup_exact::numeric / isbns_generated::numeric * 100)
      ELSE 0
    END
  ) STORED,  -- Exact dedup: dedup_exact / total * 100

  fuzzy_dedup_rate NUMERIC(5, 2) GENERATED ALWAYS AS (
    CASE
      WHEN isbns_generated > 0
      THEN (dedup_fuzzy::numeric / isbns_generated::numeric * 100)
      ELSE 0
    END
  ) STORED,  -- Fuzzy dedup: dedup_fuzzy / total * 100

  invalid_isbn_rate NUMERIC(5, 2) GENERATED ALWAYS AS (
    CASE
      WHEN isbns_generated > 0
      THEN (invalid_isbns::numeric / isbns_generated::numeric * 100)
      ELSE 0
    END
  ) STORED,  -- Invalid ISBN rate: invalid / total * 100

  cost_per_new_isbn NUMERIC(10, 4) GENERATED ALWAYS AS (
    CASE
      WHEN new_isbns > 0 AND total_cost_estimate > 0
      THEN (total_cost_estimate / new_isbns)
      ELSE NULL
    END
  ) STORED,  -- Cost efficiency: total_cost / new_isbns

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_experiment_results_run_id ON experiment_results(run_id);
CREATE INDEX IF NOT EXISTS idx_experiment_results_hit_rate ON experiment_results(hit_rate DESC);

-- =============================================================================
-- experiment_samples - Sample ISBNs for quality review
-- =============================================================================
CREATE TABLE IF NOT EXISTS experiment_samples (
  id SERIAL PRIMARY KEY,
  run_id TEXT NOT NULL REFERENCES experiment_runs(id) ON DELETE CASCADE,
  isbn TEXT NOT NULL,  -- Sample ISBN
  title TEXT,  -- Book title
  author TEXT,  -- Primary author
  confidence TEXT,  -- Confidence level from Gemini (high/low/unknown)
  dedup_status TEXT,  -- Where it was caught: exact/related/fuzzy/new
  sample_order INTEGER NOT NULL,  -- Position in sample (1-20 for quality review)

  -- Quality review fields (filled in manually)
  quality_score INTEGER,  -- 1-5 scale
  publisher_type TEXT,  -- major/indie/unknown
  language TEXT,  -- ISO language code
  publication_year INTEGER,  -- Actual publication year
  notes TEXT,  -- Review notes

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_experiment_samples_run_id ON experiment_samples(run_id);
CREATE INDEX IF NOT EXISTS idx_experiment_samples_isbn ON experiment_samples(isbn);

-- =============================================================================
-- Helper Views for Analysis
-- =============================================================================

-- View: Experiment comparison summary
CREATE OR REPLACE VIEW experiment_summary AS
SELECT
  er.experiment_name,
  er.model,
  er.year,
  er.month,
  COUNT(res.id) as runs_count,
  AVG(res.hit_rate) as avg_hit_rate,
  AVG(res.exact_dedup_rate) as avg_exact_dedup_rate,
  AVG(res.fuzzy_dedup_rate) as avg_fuzzy_dedup_rate,
  AVG(res.invalid_isbn_rate) as avg_invalid_isbn_rate,
  AVG(res.cost_per_new_isbn) as avg_cost_per_new_isbn,
  AVG(res.duration_ms) as avg_duration_ms,
  SUM(res.new_isbns) as total_new_isbns,
  SUM(res.enriched_count) as total_enriched
FROM experiment_runs er
JOIN experiment_results res ON er.id = res.run_id
GROUP BY er.experiment_name, er.model, er.year, er.month
ORDER BY avg_hit_rate DESC;

-- View: Top performers across all experiments
CREATE OR REPLACE VIEW top_performing_experiments AS
SELECT
  er.experiment_name,
  er.model,
  res.hit_rate,
  res.exact_dedup_rate,
  res.fuzzy_dedup_rate,
  res.invalid_isbn_rate,
  res.new_isbns,
  res.cost_per_new_isbn,
  er.year,
  er.month,
  er.created_at
FROM experiment_runs er
JOIN experiment_results res ON er.id = res.run_id
WHERE res.invalid_isbn_rate < 15.0  -- Filter out high-error runs
ORDER BY res.hit_rate DESC, res.exact_dedup_rate ASC
LIMIT 20;

-- =============================================================================
-- Sample Queries for Analysis
-- =============================================================================

-- Compare all variants for a specific month
-- SELECT * FROM experiment_summary WHERE year = 1985 AND month = 6 ORDER BY avg_hit_rate DESC;

-- Find best performing prompt overall
-- SELECT * FROM top_performing_experiments LIMIT 5;

-- Get detailed results for a specific experiment
-- SELECT
--   er.experiment_name,
--   er.prompt_text,
--   res.*
-- FROM experiment_runs er
-- JOIN experiment_results res ON er.id = res.run_id
-- WHERE er.experiment_name = 'diversity-emphasis-v1';

-- Cost analysis
-- SELECT
--   experiment_name,
--   SUM(total_cost_estimate) as total_cost,
--   SUM(new_isbns) as total_new_books,
--   AVG(cost_per_new_isbn) as avg_cost_per_book
-- FROM experiment_runs er
-- JOIN experiment_results res ON er.id = res.run_id
-- GROUP BY experiment_name
-- ORDER BY avg_cost_per_book ASC;
