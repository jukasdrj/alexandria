# Gemini Backfill Query Guide

**Last Updated**: 2026-01-08

## Overview

This guide documents how to query Gemini synthetic books created by the backfill pipeline. These are books generated by AI (Gemini) that exist in the database even when ISBNdb quota is exhausted.

## Quick Reference

### Query Script
```bash
./scripts/query-gemini-books.sh
```

Returns formatted table with source, title, author, and created date.

## Database Structure

### Storage Location
Synthetic books are stored in the `enriched_works` table with:
- `synthetic = true`
- `primary_provider = 'gemini-backfill'`
- Metadata in `metadata` column (JSONB)

### Metadata Structure (CRITICAL)

**The metadata is stored as a JSON STRING wrapped in JSONB**, not as a direct JSONB object.

Example raw data:
```
metadata: "{\"gemini_source\":\"backfill-2005-02\",\"gemini_author\":\"Dan Brown\",\"gemini_persisted_at\":\"2026-01-08T23:53:47.118Z\"}"
```

This requires **double parsing** to access fields.

## Query Pattern

### Correct Query
```sql
SELECT
  (metadata#>>'{}')::jsonb->>'gemini_source' as source,
  title,
  (metadata#>>'{}')::jsonb->>'gemini_author' as author,
  created_at::date as created
FROM enriched_works
WHERE synthetic = true
  AND primary_provider = 'gemini-backfill'
ORDER BY source, title;
```

### Why This Works

1. `metadata#>>'{}'` - Extracts the JSON string from JSONB (text-cast operator)
2. `::jsonb` - Parses the extracted string as JSONB
3. `->>'field'` - Accesses the field from the parsed JSONB

### Common Mistakes

❌ **WRONG**:
```sql
-- This returns NULL because metadata is a string, not an object
SELECT metadata->>'gemini_author' FROM enriched_works;
```

❌ **WRONG**:
```sql
-- This fails because metadata->0 treats it as an array
SELECT metadata->0->>'gemini_author' FROM enriched_works;
```

✅ **CORRECT**:
```sql
-- This works because we extract the string, then parse it
SELECT (metadata#>>'{}')::jsonb->>'gemini_author' FROM enriched_works;
```

## Current Data (2026-01-08)

**Total Synthetic Books**: 76

### By Source
- `backfill-2005-01`: 16 books (January 2005)
- `backfill-2005-02`: 17 books (February 2005)
- `backfill-2020-01`: 10 books (January 2020)
- `backfill-2024-01`: 10 books (January 2024)
- `backfill-2024-04`: 10 books (April 2024)
- NULL source: 13 books (metadata corruption during testing)

### Notable Books
- The Da Vinci Code - Dan Brown
- The Kite Runner - Khaled Hosseini
- The System of the World - Neal Stephenson
- Magic for Beginners - Kelly Link
- The Wager - David Grann
- The Women - Kristin Hannah

## Helper Script

Location: `/scripts/query-gemini-books.sh`

```bash
#!/bin/bash
# Query Gemini Synthetic Books
# Shows all books generated by Gemini backfill (even without ISBNs)

ssh root@Tower.local "docker exec postgres psql -U openlibrary -d openlibrary -c \"
SELECT
  (metadata#>>'{}')::jsonb->>'gemini_source' as source,
  title,
  (metadata#>>'{}')::jsonb->>'gemini_author' as author,
  created_at::date as created
FROM enriched_works
WHERE synthetic = true
  AND primary_provider = 'gemini-backfill'
ORDER BY 1, 2;
\""
```

## Troubleshooting

### Empty Results
If you get empty `author` or `source` columns:
1. Check if metadata is stored as a string: `SELECT jsonb_typeof(metadata) FROM enriched_works WHERE synthetic = true LIMIT 1;`
2. If it returns `'string'`, use the double-parsing pattern above
3. If it returns `'object'`, you can use direct access: `metadata->>'field'`

### Null Values
Some records may have NULL source/author due to:
- Array-wrapped metadata (early implementation)
- Metadata corruption during testing
- Incomplete persistence

To count these:
```sql
SELECT COUNT(*) FROM enriched_works
WHERE synthetic = true
  AND (metadata#>>'{}')::jsonb->>'gemini_author' IS NULL;
```

## Integration Points

These synthetic books:
- ✅ Are searchable via title/author search
- ✅ Have work records in `enriched_works`
- ❌ Do NOT have ISBNs (quota exhausted)
- ❌ Do NOT have external IDs (Amazon, Goodreads, etc.)
- ❌ Do NOT have cover images
- ⏳ Can be enhanced later when ISBNdb quota available

## Future Work

1. **Fix metadata storage** - Store as direct JSONB object instead of stringified JSON
2. **Backfill enhancement** - Retry ISBN resolution when quota resets
3. **Cover acquisition** - Queue cover downloads for synthetic works
4. **Quality scoring** - Add completeness scores based on available metadata
