# NFS Setup & Docker Permissions Fix - 2026-01-06

## Summary
Successfully configured NFS automount from Mac to Tower Unraid server and resolved Docker container permission issues preventing file operations.

## Problems Solved

### 1. NFS Shares Not Accessible
- **Issue:** Tower's NFS exports not mounted on Mac
- **Solution:** Configured macOS automounter with `/etc/auto_master` and `/etc/auto_tower`
- **Result:** Shares auto-mount on-demand at `/Tower/domains` and `/Tower/data`

### 2. Files "Locked" / Permission Denied
- **Issue:** Cannot move/delete files downloaded by qBittorrent
- **Root Cause:** qBittorrent container running with PUID=1000 instead of PUID=99
- **Solution:** Recreated container with correct PUID=99 (nobody) and PGID=100 (users)
- **Result:** All new downloads have correct ownership; existing files fixed with chown

### 3. Finder View Settings Not Persisting
- **Issue:** Folders on top, list view, etc. reset every folder
- **Solution:** Set global Finder defaults and cleared corrupted .DS_Store files
- **Result:** Consistent view across all folders

## Files Created/Modified

### Configuration Files
- `/etc/auto_master` - Added `/Tower auto_tower -nobrowse,nosuid`
- `/etc/auto_tower` - NFS mount definitions with optimized parameters
- Finder global defaults applied via `defaults write`

### Scripts
- `/tmp/fix_finder_views.sh` - Set Finder preferences (folders on top, list view)
- `/tmp/fix_nfs_delete.sh` - Unlock files and fix Tower permissions
- `/tmp/fix_tower_nfs.sh` - Complete NFS setup script
- `~/dev_repos/alex/scripts/fix-nfs-permissions.sh` - Reusable permission fix script

### Documentation
- `~/dev_repos/alex/docs/infrastructure/INFRASTRUCTURE.md`
  - Added NFS Share Access section
  - Added Docker PUID/PGID requirements
  - Added Common Issues & Solutions section
  - Updated version history
- `~/dev_repos/alex/docs/ALIASES.md`
  - Added NFS mount commands
  - Added fix-nfs-permissions.sh reference
  - Updated version history

## Technical Details

### NFS Mount Configuration
```bash
# /etc/auto_tower
domains		-fstype=nfs,resvport,rw,bg,hard,intr,rsize=65536,wsize=65536,timeo=14,nolocks	192.168.1.240:/mnt/user/domains
data		-fstype=nfs,resvport,rw,bg,hard,intr,rsize=65536,wsize=65536,timeo=14,nolocks	192.168.1.240:/mnt/user/data
```

**Key Parameters:**
- `resvport` - Required for macOS NFS security
- `rsize/wsize=65536` - Optimal transfer block sizes
- `bg,hard,intr` - Background mount, hard mount with interrupt support
- `nolocks` - Avoids lock manager issues with Unraid
- `timeo=14` - 1.4 second timeout before retry

### Docker Container Fix
```bash
# Before: PUID=1000 (user justin)
# After:  PUID=99 (nobody)

docker run -d \
  --name=qbittorrent \
  -e PUID=99 \
  -e PGID=100 \
  ...
```

**Why This Matters:**
- NFS shares expect `nobody:users` (99:100) for universal access
- Container running as PUID=1000 created files owned by UID 1000
- Mac NFS client couldn't write to files owned by UID 1000
- Changed to PUID=99 ensures all files have correct ownership

### File Permissions Applied
```bash
# Directories: 755 (rwxr-xr-x)
find /mnt/user/data -type d -exec chmod 755 {} \;

# Files: 644 (rw-r--r--)
find /mnt/user/data -type f -exec chmod 644 {} \;

# Ownership: nobody:users
chown -R nobody:users /mnt/user/data
```

## Verification Commands

```bash
# Check NFS exports from Tower
showmount -e 192.168.1.240

# Verify mounts
nfsstat -m | grep Tower

# Check container PUID
ssh tower "docker inspect qbittorrent | grep PUID"

# Test file operations
touch /Tower/data/test.txt && rm /Tower/data/test.txt
```

## Future Maintenance

### When Adding New Docker Containers
Always set for LinuxServer.io containers:
- PUID=99
- PGID=100

### If Permission Issues Reoccur
```bash
cd ~/dev_repos/alex/scripts
./fix-nfs-permissions.sh [container_name] [problematic_path]
```

### If NFS Shares Won't Mount
```bash
# Trigger automount
ls /Tower/domains

# Restart automounter
sudo automount -vc

# Check logs
log show --predicate 'process == "automountd"' --last 5m
```

## Lessons Learned

1. **Always verify Docker PUID** - Default 1000 causes NFS permission issues
2. **NFS + Docker requires nobody:users** - Standard for Unraid shares
3. **macOS automounter is lazy** - Directories don't appear until first access
4. **Finder sidebar items can break** - Need re-adding after share unmounts
5. **.DS_Store on NFS can corrupt** - Clean them out when view settings won't persist

## Related Issues Prevented

- SABnzbd likely has same PUID issue - should verify and fix
- Any future download/automation containers must use PUID=99
- Time Machine backups to NFS would need similar consideration

## Access After Reboot

NFS mounts persist across reboots via `/etc/auto_master`. Just access the directories:
```bash
cd /Tower/domains  # Auto-mounts on access
```

Finder favorites may need to be re-added if the share was unmounted before reboot.
