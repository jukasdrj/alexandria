# SMB Setup Complete - 2026-01-06

## Summary
Successfully migrated from NFS to SMB with AutoMounter for reliable, permission-friendly access to Tower shares.

## Why We Switched from NFS to SMB
- NFS had persistent permission issues on macOS
- Files appeared "locked" and couldn't be moved/deleted
- macOS SMB integration is superior (proper locking, Finder integration)
- AutoMounter provides better connection management

## Final Configuration

### Tower (Unraid) SMB Shares

**Location:** `/etc/samba/smb-shares.conf`

**Shares configured:**
- `domains` - Development & VMs (1.36 TB)
- `data` - Media & Downloads (72.23 TB)

**Settings:**
```ini
[domains]
    path = /mnt/user/domains
    browseable = yes
    writable = yes
    valid users = justin
    write list = justin
    force user = nobody
    force group = users
    create mask = 0664
    directory mask = 0775
    vfs objects = fruit streams_xattr
    fruit:metadata = stream
    fruit:model = MacSamba
    fruit:posix_rename = yes
    fruit:veto_appledouble = no
    fruit:wipe_intentionally_left_blank_rfork = yes
    fruit:delete_empty_adfiles = yes

[data]
    path = /mnt/user/data
    browseable = yes
    writable = yes
    valid users = justin
    write list = justin
    force user = nobody
    force group = users
    create mask = 0664
    directory mask = 0775
    vfs objects = fruit streams_xattr
    fruit:metadata = stream
    fruit:model = MacSamba
    fruit:posix_rename = yes
    fruit:veto_appledouble = no
    fruit:wipe_intentionally_left_blank_rfork = yes
    fruit:delete_empty_adfiles = yes
```

**macOS Optimizations Applied:**
- `fruit` VFS module - Enhanced macOS compatibility
- `fruit:metadata = stream` - Store macOS metadata in alternate data streams
- `fruit:model = MacSamba` - Advertise as Mac-compatible server
- `fruit:posix_rename` - Proper rename behavior for macOS
- `fruit:veto_appledouble` - Don't block ._ files
- `fruit:delete_empty_adfiles` - Clean up empty resource forks

### Bonjour/mDNS Discovery

**Status:** ✅ Working
- Tower advertises as `Tower.local` via Avahi
- Detected on network: `_smb._tcp.` service

**Verification:**
```bash
dns-sd -B _smb._tcp .
# Shows: Tower on local domain
```

### AutoMounter Configuration (Mac)

**App:** AutoMounter.app (paid, installed at `/Applications/AutoMounter.app`)

**Settings:**
- **Server:** `Tower.local` (Bonjour name)
- **Protocol:** SMB
- **Username:** `justin`
- **Password:** Unraid password for justin user

**Shares mounted:**
1. `domains` → `/Volumes/domains`
2. `data` → `/Volumes/data`

**Options enabled:**
- ✅ Mount using Bonjour
- ✅ Unmount shares when unavailable
- ✅ Connect automatically
- ✅ Mount at login

**Finder Favorites:**
- Both shares added to Finder sidebar under Favorites

## Permission Cleanup

### Issues Found from NFS Migration
- **428 directories** in `/mnt/user/data/adult` with wrong ownership
- **36 directories** in `/mnt/user/domains` with wrong ownership
- Ownership was various UIDs (501, 1000, etc.) instead of `nobody:users`
- Permissions were 755 (read-only for group) instead of 775 (group writable)

### Fix Applied
```bash
# Fixed ownership
chown -R nobody:users /mnt/user/data
chown -R nobody:users /mnt/user/domains

# Fixed permissions
find /mnt/user/data -type d -exec chmod 775 {} \;
find /mnt/user/data -type f -exec chmod 664 {} \;
find /mnt/user/domains -type d -exec chmod 775 {} \;
find /mnt/user/domains -type f -exec chmod 664 {} \;
```

**Result:**
- ✅ All directories: 775 (rwxrwxr-x) - User and group can write
- ✅ All files: 664 (rw-rw-r--) - User and group can write
- ✅ Owner: nobody:users (standard for Unraid SMB)

### Specific Issues Fixed
- `pic_2_review` folder - Was UID 501, now nobody:users with 775
- Various torrent download folders - Were UID 1000, fixed
- Multiple subdirectories with 755 instead of 775 - Fixed

## Docker Container Settings (Maintained)

**qBittorrent container** still configured with correct settings:
- PUID=99 (nobody)
- PGID=100 (users)
- UMASK=000 (creates files with proper permissions)

This ensures new downloads have correct ownership for SMB access.

## Testing & Verification

**Tested operations:**
- ✅ Move folders between directories
- ✅ Delete files and folders
- ✅ Create new files and folders
- ✅ Rename items
- ✅ Copy files to shares
- ✅ Paste folders into previously problematic directories

**No "locked" errors or permission denied issues.**

## Performance

**SMB vs NFS:**
- SMB: Slightly slower raw throughput (~10-15%)
- But: No permission issues, better reliability, "just works"
- AutoMounter handles reconnection automatically
- Bonjour discovery works seamlessly

**Verdict:** Reliability > Raw speed for daily use

## Maintenance

### If Permissions Get Messed Up Again
Run this on Tower:
```bash
# Fix data share
chown -R nobody:users /mnt/user/data
find /mnt/user/data -type d -exec chmod 775 {} \;
find /mnt/user/data -type f -exec chmod 664 {} \;

# Fix domains share
chown -R nobody:users /mnt/user/domains
find /mnt/user/domains -type d -exec chmod 775 {} \;
find /mnt/user/domains -type f -exec chmod 664 {} \;
```

### If AutoMounter Stops Working
1. Check Tower is reachable: `ping Tower.local`
2. Check SMB is running: `ssh tower "/etc/rc.d/rc.samba status"`
3. Restart SMB: `ssh tower "/etc/rc.d/rc.samba restart"`
4. Quit and restart AutoMounter app

### If Share Won't Mount
1. Verify credentials in AutoMounter
2. Check Unraid SMB users: `ssh tower "pdbedit -L"`
3. Test manual connection: `open smb://Tower.local/data`
4. Check share config: `ssh tower "testparm -s | grep -A 10 domains"`

## Files Created/Modified

### Tower (Unraid)
- `/etc/samba/smb-shares.conf` - SMB share definitions
- `/etc/samba/smb.conf` - Includes smb-shares.conf
- Permission fixes on 464 directories total

### Mac
- AutoMounter.app configured (preferences in `~/Library/Preferences/nz.co.pixeleyes.AutoMounter.plist`)
- Finder favorites added for both shares

### Documentation
- `~/dev_repos/alex/docs/infrastructure/SMB-SETUP-2026-01-06.md` (this file)
- `~/dev_repos/alex/docs/infrastructure/NFS-REMOVAL-2026-01-06.md` (previous)

## Next Steps

**Optional improvements:**
1. Set up Time Machine backup to `/Volumes/domains/time_machine`
2. Add other Unraid shares if needed (media, backups, etc.)
3. Configure AutoMounter notifications for mount/unmount events

## Lessons Learned

1. **SMB > NFS for macOS** - Period. Don't fight it.
2. **AutoMounter is worth it** - Better than manual mounting or automount.d
3. **Bonjour/mDNS "just works"** - `Tower.local` is more reliable than IP
4. **Permission inheritance matters** - 775 for dirs, 664 for files, nobody:users owner
5. **Docker UMASK affects everything** - Make sure containers create files with correct perms
6. **Clean up after experiments** - NFS left 464 directories with wrong permissions

## Related Documentation

- Infrastructure: `~/dev_repos/alex/docs/infrastructure/INFRASTRUCTURE.md`
- NFS Removal: `~/dev_repos/alex/docs/infrastructure/NFS-REMOVAL-2026-01-06.md`
- Aliases: `~/dev_repos/alex/docs/ALIASES.md`
