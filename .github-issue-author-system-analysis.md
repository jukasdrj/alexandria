# Author System Architecture Analysis & Verification

**Context:** During Wikipedia integration (Phase 3 of Open API Integration), we discovered potential inconsistencies and unclear utility in the author data architecture across multiple tables.

**Priority:** MEDIUM - Not blocking current work, but critical for long-term maintainability

---

## Current State (Discovered Issues)

### Multiple Author Tables

| Table | Row Count | Purpose | Primary Key |
|-------|-----------|---------|-------------|
| `authors` | 14.7M | OpenLibrary source data (read-only) | `key` TEXT |
| `enriched_authors` | 14.7M | Alexandria enrichment layer | `author_key` TEXT |
| `authors_canonical` | ? | Unknown purpose | ? |
| `author_works` | 42.8M | Author-work relationships | ? |
| `work_authors_enriched` | ? | Unknown purpose | ? |
| `external_id_mappings_authors` | ? | External ID crosswalk (partitioned) | ? |

### Data Synchronization Issues

**Problem:** Wikidata IDs exist in source `authors` table but are NOT synced to `enriched_authors`

**Example (J.K. Rowling):**
```sql
-- Source table has Wikidata ID
SELECT data#>>'{0,remote_ids,wikidata}' FROM authors WHERE key = '/authors/OL23919A';
-- Result: Q34660

-- Enriched table does NOT have it
SELECT wikidata_id FROM enriched_authors WHERE author_key = '/authors/OL23919A';
-- Result: NULL (or empty row)
```

**Stats:**
- `authors` table: 14.7M authors with `remote_ids` JSONB containing Wikidata/VIAF/Goodreads/ISNI
- `enriched_authors.wikidata_id`: 174K authors (only 1.2% populated!)
- **Missing sync:** ~13.5M authors may have Wikidata IDs in source that aren't in enriched table

### Biography Data Duplication

**Multiple biography fields in `enriched_authors`:**

| Column | Type | Count Populated | Source |
|--------|------|-----------------|--------|
| `bio` | TEXT | 28,307 | OpenLibrary plain text |
| `biography_data` | JSONB | 0 (NEW) | Wikipedia structured data |
| `bio_source` | TEXT | ? | Unknown tracking |
| `metadata` | JSONB | ? | Generic catch-all |

**Questions:**
1. Should `bio` be display text and `biography_data` be structured metadata? (Current plan)
2. Is `metadata` JSONB being used for author data? If yes, is it redundant with `biography_data`?
3. Should we migrate old `bio` → `biography_data` or keep both?

### External ID Storage Patterns

**Current patterns (unclear consistency):**

```sql
-- Pattern 1: Arrays in enriched_authors
goodreads_author_ids TEXT[]
librarything_ids TEXT[]
google_books_ids TEXT[]

-- Pattern 2: Single text field
wikidata_id TEXT
openlibrary_author_id TEXT

-- Pattern 3: JSONB in source table
authors.data->'remote_ids'->>'wikidata'
authors.data->'remote_ids'->>'viaf'
authors.data->'remote_ids'->>'goodreads'
authors.data->'remote_ids'->>'isni'

-- Pattern 4: External ID crosswalk table (Issue #155)
external_id_mappings_authors (partitioned)
```

**Questions:**
1. Why 4 different patterns for the same concept?
2. Should all external IDs use crosswalk table? (Most scalable)
3. How do we sync `authors.remote_ids` → `enriched_authors` fields?

---

## Questions Requiring Analysis

### Table Purpose & Utility

1. **authors_canonical**: What is this table for? Is it used? Can we deprecate it?
2. **work_authors_enriched**: How does this differ from `author_works`? Do we need both?
3. **external_id_mappings_authors**: Is this being populated? Is it the source of truth?

### Data Flow & Synchronization

4. **Sync strategy**: How/when does data flow from `authors` → `enriched_authors`?
   - Is there an ETL job?
   - Is it on-demand (lazy)?
   - Is it manual?
5. **Wikidata ID sync**: Why are 13.5M Wikidata IDs missing from `enriched_authors`?
6. **Consistency**: Are `author_key` and `key` always 1:1 mappings?

### Biography Data Strategy

7. **Biography fields**: Should we consolidate `bio`, `biography_data`, `metadata`?
8. **Display vs structured**: Should `bio` = display text, `biography_data` = structured metadata?
9. **Migration**: Should we backfill `biography_data` from existing `bio` TEXT?

### External IDs

10. **Crosswalk adoption**: Should we migrate all external IDs to `external_id_mappings_authors`?
11. **Array columns**: Should we deprecate `goodreads_author_ids[]`, `librarything_ids[]`, etc.?
12. **Source of truth**: Is `authors.remote_ids` or `enriched_authors.*_ids` the source of truth?

---

## Impact on Current Systems

### Affected Features

- **Wikipedia integration** (Phase 3): Needs Wikidata ID sync to avoid fuzzy name matching
- **External ID resolution** (Issue #155): Relies on crosswalk table consistency
- **Author enrichment queue**: Unclear which table to query for latest data
- **Author API endpoints**: May return stale/inconsistent data

### Performance Concerns

- **Duplicate queries**: May be querying both `authors` and `enriched_authors` for same data
- **Index coverage**: Unknown if indexes cover actual query patterns
- **Partition strategy**: `external_id_mappings_authors` partitioned by entity_type - is this optimal?

---

## Recommended Actions

### Phase 1: Discovery (2-3 hours)

1. **Document table purposes**
   - Interview code/database history
   - Check for references in codebase
   - Identify dead/unused tables

2. **Analyze data flow**
   - Find ETL jobs or sync mechanisms
   - Trace author creation → enrichment pipeline
   - Document when/how data moves between tables

3. **Query pattern analysis**
   - Grep codebase for author table queries
   - Identify common JOIN patterns
   - Check index coverage for hot queries

### Phase 2: Verification (3-4 hours)

4. **Consistency checks**
   - Verify `author_key` = `key` 1:1 mapping
   - Check foreign key constraints
   - Validate external ID sync state

5. **Data quality audit**
   - Measure NULL rates for key columns
   - Check for duplicate/conflicting data
   - Validate JSONB schema consistency

6. **Performance profiling**
   - Run EXPLAIN ANALYZE on author queries
   - Check slow query logs
   - Identify missing indexes

### Phase 3: Recommendations (1-2 hours)

7. **Architecture proposal**
   - Consolidate or deprecate redundant tables
   - Standardize external ID storage
   - Define clear data flow patterns

8. **Migration plan**
   - Wikidata ID sync strategy
   - Biography data consolidation
   - External ID migration to crosswalk

---

## Acceptance Criteria

- [ ] All 6 author tables documented with purpose + usage
- [ ] Data flow diagram: OpenLibrary → enriched_authors → external APIs
- [ ] Wikidata ID sync issue root cause identified
- [ ] Biography data strategy decision documented
- [ ] External ID standardization plan
- [ ] Dead/unused tables identified for deprecation
- [ ] Index coverage validated for hot queries
- [ ] Performance recommendations (if applicable)

---

## Related Work

- **Completed:** Wikipedia integration with ID-based lookup (avoids fuzzy matching)
- **Related:** Issue #155 (External ID Resolution) - Crosswalk table usage
- **Blocked by:** Author queue processing (Phase 3) - Needs clear data flow
- **Planning:** `.planning/api-integration-task_plan.md`

---

## Discovery Questions for Investigation

**Run these queries to start:**

```sql
-- Table sizes
SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename))
FROM pg_tables
WHERE tablename LIKE '%author%'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Foreign key relationships
SELECT
  tc.table_name,
  kcu.column_name,
  ccu.table_name AS foreign_table_name,
  ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
  AND tc.table_name LIKE '%author%'
ORDER BY tc.table_name;

-- Check for references to authors_canonical
SELECT tablename, attname as column_name
FROM pg_stats
WHERE tablename LIKE '%author%canonical%';

-- Wikidata ID sync gap analysis
SELECT
  (SELECT COUNT(*) FROM authors WHERE data#>>'{0,remote_ids,wikidata}' IS NOT NULL) as source_wikidata_count,
  (SELECT COUNT(*) FROM enriched_authors WHERE wikidata_id IS NOT NULL) as enriched_wikidata_count,
  (SELECT COUNT(*) FROM authors WHERE data#>>'{0,remote_ids,wikidata}' IS NOT NULL) -
  (SELECT COUNT(*) FROM enriched_authors WHERE wikidata_id IS NOT NULL) as sync_gap;
```

---

## Notes

- This issue was created during Wikipedia integration when we discovered Wikidata IDs weren't synced
- The refactored `wikipedia.ts` now queries both `enriched_authors` AND source `authors` table to get Wikidata IDs
- This is a workaround - proper fix requires understanding the architecture
- No immediate action required, but should be prioritized for Q1 2026
