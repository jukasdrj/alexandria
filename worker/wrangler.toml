name = "alexandria"
main = "index.js"
compatibility_date = "2024-11-20"
compatibility_flags = ["nodejs_compat"]

# Custom domain for Worker
[[routes]]
pattern = "alexandria.ooheynerds.com"
custom_domain = true

# Hyperdrive binding for PostgreSQL
[[hyperdrive]]
binding = "HYPERDRIVE"
id = "00ff424776f4415d95245c3c4c36e854"
localConnectionString = "postgres://openlibrary:tommyboy@alexandria-db.ooheynerds.com:5432/openlibrary?sslmode=require"

# Analytics Engine for monitoring and logging
[[analytics_engine_datasets]]
binding = "ANALYTICS"

# =============================================================================
# Secrets Store Bindings (account-level secrets)
# =============================================================================
# These use Cloudflare Secrets Store for centralized secret management.
# Store ID: b0562ac16fde468c8af12717a6c88400 (default_secrets_store)
#
# IMPORTANT: Access pattern differs from regular env variables!
#   Regular secret:       env.SECRET_NAME (string)
#   Secrets Store:        await env.SECRET_NAME.get() (async)
#
# Usage in code:
#   const isbndbKey = await env.ISBNDB_API_KEY.get();
#   const googleBooksKey = await env.GOOGLE_BOOKS_API_KEY.get();
# =============================================================================

# ISBNdb API - Primary source for cover images and book metadata
# Rate limit: 1 request/second on paid plan
[[secrets_store_secrets]]
binding = "ISBNDB_API_KEY"
store_id = "b0562ac16fde468c8af12717a6c88400"
secret_name = "ISBNDB_API_KEY"

# Google Books API - Fallback for cover images
[[secrets_store_secrets]]
binding = "GOOGLE_BOOKS_API_KEY"
store_id = "b0562ac16fde468c8af12717a6c88400"
secret_name = "Google_books_hardoooe"

# =============================================================================
# R2 Storage Bindings
# =============================================================================
# R2 bucket for cover image storage
# Structure: isbn/{isbn13}/[original|large|medium|small].webp
#
# Usage in code:
#   await env.COVER_IMAGES.put(key, data, { httpMetadata: {...} })
#   const obj = await env.COVER_IMAGES.get(key)
#   await env.COVER_IMAGES.head(key)  // Check existence
# =============================================================================

[[r2_buckets]]
binding = "COVER_IMAGES"
bucket_name = "bookstrack-covers-processed"

# =============================================================================
# KV Namespace Bindings
# =============================================================================
# KV for caching, rate limiting, and metadata storage
#
# Usage in code:
#   await env.CACHE.get(key)
#   await env.CACHE.put(key, value, { expirationTtl: 3600 })
# =============================================================================

[[kv_namespaces]]
binding = "CACHE"
id = "dd278b63596b4f96828c7db4b3d9adf1"
